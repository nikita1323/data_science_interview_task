# Пайплайн по обнаружению людей на видео

Данный репозиторий посвящен выполнению тестового задания на позицию Data Scientist. Задача: детектирование и выделение людей в кадре (видео).

---

## Описание проекта

1. **Первые шаги**
   - Написание простого скрипта по распознаванию людей в кадре с использованием YOLO; препроцессинг видео mp4; инференс модели с различными параметрами и отрисовка bounding box-ов.
   - Основной фокус шел на отлаживание правильной работы скрипта и достижения лучших результатов инференса модели.
   - Использование модели DETR (Detection Transformer) и ее инференс.
2. **Дополнительные моменты**
   - Добавление многоядерности для параллельного инференса сразу двух моделей.
3. **Финальные доработки**
   - Реструктуризация проекта под стиль ООП.
   - Введение аргументов командной строки для управления параметрами инференса моделей.

---

## Руководство по установке

На данном этапе проект очень простой и легко поддерживает кросплатформенность. Дальнейшие шаги по работе с проектом:

### Основные требования

- **Python**: протестировано на версии 3.12.9.
- **CUDA** (по выбору): Для ускорения вычислений на видеокарте (NVIDIA GPU + CUDA Toolkit, например, 12.6). Протестировано на версии 12.6. Инструкция по установке: <https://docs.nvidia.com/cuda/cuda-quick-start-guide/#>
- **pip**: убедитесь в наличии `pip` (`python -m ensurepip --upgrade`).

### Этапы

1. **Клонируйте репозиторий**  

   ```bash
   git clone https://github.com/nikita1323/data_science_interview_task.git
   cd data_science_interview_task
   ```

2. **Настройте виртуальное окружение**
   - Windows:

     ```bash
     python -m venv venv
     venv\Scripts\activate
     ```

   - macOS/Linux:

     ```bash
     python3 -m venv venv
     source venv/bin/activate
     ```

3. **Установите необходимые зависимости**
   - Команда для вычислений на CPU:

     ```bash
     pip install -r requirements.txt
     ```

   - Команда для вычислений на GPU (меняйте версию CUDA по необходимости):

     ```bash
     pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu126
     pip install -r requirements.txt
     ```

4. **Убедитесь в правильной установке зависимостей**

   ```bash
   python -c "import cv2, numpy, torch, torchvision, transformers, ultralytics; print('Ready to roll!')"
   ```

   - Проверка модулей для поддержки GPU:

     ```bash
     python -c "import torch; print(torch.cuda.is_available())"
     ```

     (должно вывести `True` если CUDA установилась правильно).

---

## Как запустить приложение

Для запуска приложения необходимо запустить `main.py` из командной строки:

### Базовый запуск

```bash
python main.py --input_path path_to_your_video.mp4
```

- Инференс сразу 2 моделей YOLO и DETR; на выходе `path_to_yolo_output.mp4` (зеленые рамки) и `path_to_detr_output.mp4` (голубые рамки).

### Параметры командной строки

Все параметры опциональны (за исключением  `--input_path`):

|        Параметр         | Тип данных |    Значение по умолчанию    |                              Описание                              |
| :---------------------: | :--------: | :-------------------------: | :----------------------------------------------------------------: |
|     `--input_path`      |    str     |         Обязательно         |                Путь к файлу (например, `video.mp4`)                |
|        `--mode`         |    str     |            `all`            |                `yolo_only`, `detr_only`, или `all`                 |
|     `--batch_size`      |    int     |              8              |                    Размер входного батча кадров                    |
|  `--yolo_output_path`   |    str     |    `output/yolo12n.mp4`     |                       Выходной файл для YOLO                       |
|   `--yolo_model_name`   |    str     |          `yolo12n`          |                            Модель YOLO                             |
| `--yolo_conf_threshold` |   float    |            0.25             |    Степень уверенности модели в обнаружении конкретного объекта    |
| `--yolo_iou_threshold`  |   float    |            0.85             | Параметр для учета степени наложения bounding box-ов друг на друга |
|    `--yolo_if_half`     |    bool    |           `False`           |                         Использование FP16                         |
|   `--yolo_if_verbose`   |    bool    |           `False`           |          Вывод информации в процессе инференса в консоль           |
|  `--detr_output_path`   |    str     | `output/detr-resnet-50.mp4` |                       Выходной файл для DETR                       |
|   `--detr_model_name`   |    str     |          `yolo12n`          |                            Модель YOLO                             |
| `--detr_conf_threshold` |   float    |             0.5             |    Степень уверенности модели в обнаружении конкретного объекта    |
| `--detr_iou_threshold`  |   float    |             0.1             | Параметр для учета степени наложения bounding box-ов друг на друга |
|   `--detr_if_verbose`   |    bool    |           `False`           |          Вывод информации в процессе инференса в консоль           |

### Примеры использования

- Только YOLO:

  ```bash
  python main.py --input_path video.mp4 --mode yolo_only
  ```

- Только DETR:

  ```bash
  python main.py --input_path video.mp4 --mode detr_only
  ```

- Изменение размера батча:

  ```bash
  python main.py --input_path video.mp4 --batch_size=16
  ```

---

## Что можно улучшить

Поскольку эта работа находится на начальной стадии, есть множество улучшений которые можно добавить:

1. Fine-Tuning моделей
   - Уменьшение количества распознаваемых классов для ускорения инференса
   - Дообучение на наборе данных, наилучшим образом подходящим под поставленную задачу (например, обнаружение людей в большой толпе).
2. Применение Multi-Head Attention моделей
   - Основное их преимущество заключается в том, что на вход поступает сразу несколько кадров и благодаря Attention механизму, учитывающим взаимосвязи сразу между несколькими изображениями, нейросети удается лучше распознавать паттерны, соответствующие определенному виду объектов.
3. Оптимизация
   - Для еще большего ускорения инференса и переноса модели на iot устройства можно применить квантование.
